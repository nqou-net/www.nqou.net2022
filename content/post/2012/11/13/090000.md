---
date: 2012-11-13T09:00:00+09:00
draft: false
iso8601: 2012-11-13T09:00:00+09:00
tags:
  - perl
  - wordpress
title: 「nginx + WordPress + multisite」で、アップロードしたファイルをちゃんと表示できるようになった

---

<p>「nginx + WordPress + multisite」で、アップロードしたファイルをちゃんと表示できるようになったので、簡単に記録しておきます。</p> <h3>ぶち当たった問題</h3> <ul><li>画像をアップロードして記事に埋め込んだが、画像が表示されない（404エラー）</li></ul><h3>原因</h3> <ul><li>nginxの設定</li></ul><h3>解決方法</h3> <ol><li>WordPressで「nginx-helper」というプラグインを入れて、適切に設定する</li><li>nginxの設定ファイルを適切に設定する。</li></ol><h3>参考になったページ</h3> <ul><li><a href="http://wiki.nginx.org/WordPress#Rewrite_rules_for_Multisite_using_subdomains">http://wiki.nginx.org/WordPress#Rewrite_rules_for_Multisite_using_subdomains</a></li></ul><h3>細かいこと</h3> <p>参考にしたページの設定は、「nginx-helper」というプラグインを利用するのが前提になっているようなので、忘れずに入れて設定しておきます。</p> <p>プラグイン設定方法は、以下のとおりです。</p> <ol><li>「nginx-helper」をインストールする。</li><li>画面左側のメニューから「設定」→「Nginx Helper」とクリックして設定画面を出す。</li><li>「Enable Nginx Map.」にチェックを入れて「Save」します。</li></ol><p>プラグインについては以上です。</p> <p>ただし、このプラグインの情報にしたがって、nginxの設定を書きなおす必要があります。</p> <p>必要な情報は以下のとおりです。</p> <ol><li>「save」した後、「Nginx Map」という設定が出てくるので、その中の「Nginx Map path to include in nginx settings」の右側の文字列をコピーして貼り付けます。</li></ol>```default
map $http_host $blogid {<br>    default       -999;<br>    include （ここに貼り付け）;<br>}<br><br>（中略）<br><br>#WPMU Files<br>location ~ ^/files/(.*)$ {<br>    try_files /wp-content/blogs.dir/$blogid/$uri /wp-includes/ms-files.php?file=$1;<br>    access_log off; log_not_found off;      expires max;<br>}<br>
``` <p>マルチサイトにした場合、サイト（ブログ）をごとに$blogidが割り振られますが、サイトのホスト名とIDを紐付けておくことで、nginxで画像を処理できるようになります。</p> <p>この設定は、PHPの起動回数を減らすことにつながるので、サーバーの負荷を減らしたり、高速化を目指す場合は必須です。</p> <p>で、問題は、この「WPMU Files」の設定なのですが、他の静的なファイルの設定は、この設定よりも前には書かないほうがよさそうです。</p> <h3>confファイル</h3> <p>最後に、ヴァーチャルホストの設定ファイルを晒しておきます。</p> <p>継ぎ接ぎだらけですが、何かのお役に立てば幸いです。</p> ```default
map $http_host $blogid {<br>    default       -999;<br>    include       /var/www/soc/wp-content/plugins/nginx-helper/map.conf;<br>}<br><br>server {<br>    listen       80;<br>    server_name  .wp.nishimiyahara.net;<br><br>    access_log /var/log/nginx/wp_soc.access.log;<br>    error_log  /var/log/nginx/wp_soc.error.log;<br><br>    root /var/www/soc;<br>    index index.php;<br><br>    location = /favicon.ico {<br>        log_not_found off;<br>        access_log off;<br>    }<br><br>    location = /robots.txt {<br>        allow all;<br>        log_not_found off;<br>        access_log off;<br>    }<br><br>    location / {<br>        try_files $uri $uri/ /index.php?$args;<br>    }<br><br>    location ~ \.php$ {<br>        include        /etc/nginx/fastcgi.conf;<br>        fastcgi_pass   unix:/var/run/php-fpm/php-fpm.sock;<br>    }<br><br>    #WPMU Files<br>    location ~ ^/files/(.*)$ {<br>        try_files /wp-content/blogs.dir/$blogid/$uri /wp-includes/ms-files.php?file=$1;<br>        access_log off;<br>        log_not_found off;<br>        expires max;<br>    }<br><br>    #WPMU x-sendfile to avoid php readfile()<br>    location ^~ /blogs.dir {<br>        internal;<br>        alias /var/www/soc/wp-content/blogs.dir;<br>        access_log off;<br>        log_not_found off;<br>        expires max;<br>    }<br><br>    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {<br>        log_not_found off;<br>        expires max;<br>    }<br>}<br>
```    	