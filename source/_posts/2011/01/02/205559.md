---
categories:
  - 情報技術について
date: 2011-01-02 20:55:59
id: 442
iso8601: 2011-01-02T20:55:59+09:00
tags:
  - mojolicious
  - perl
title: Mojolicious::LiteでData::Modelを使ってみた

---

先日1.0にバージョンアップしたMojolicious（::Lite）を本格的に触ってみようとアレコレやってみた。
MojoliciousのWikiにORLiteを使ったサンプルがあったのですが、残念ながらそのままでは日本語には対応していないので、他のORMを使ってみようという、そんな感じです。
<div>
<p>SEE ALSO</p>
<ul>
<li><a href="http://search.cpan.org/dist/Data-Model/">Kazuhiro Osawa / Data-Model - search.cpan.org</a></li>
<li><a href="http://perl-users.jp/articles/advent-calendar/2009/data-model/">Data::Model Track - JPerl Advent Calendar 2009</a></li>
<li><a href="http://search.cpan.org/dist/Mojolicious/">Sebastian Riedel / Mojolicious - search.cpan.org</a></li>
<li><a href="https://github.com/kraih/mojo/wiki">Working with orlite inside mojolicious - mojo - GitHub</a></li>
</ul>
</div>


ほとんどが元ネタのパクリですが。
```default
#!/usr/bin/env perl
#ｕｔｆ８
# use Acme::PerlTidy;
package DataModel;
use utf8;
use base 'Data::Model';
use Data::Model::Schema;
use Data::Model::Driver::DBI;
my $dbfile = qq{$0.db};
my $dsn    = qq{dbi:SQLite:dbname=$dbfile};
my $driver = Data::Model::Driver::DBI-&gt;new(
dsn             =&gt; $dsn,
connect_options =&gt; {sqlite_unicode =&gt; 1,},
);
base_driver($driver);
install_model motorcycles =&gt; schema {
key 'id';
column id    =&gt; int  =&gt; {auto_increment =&gt; 1};
column type  =&gt; char =&gt; {required       =&gt; 1};
column brand =&gt; char =&gt; {required       =&gt; 1};
column color =&gt; char =&gt; {required       =&gt; 0};
};
unless (-f $dbfile) {
my $dbh = DBI-&gt;connect($dsn, '', '', {RaiseError =&gt; 1, PrintError =&gt; 0})
or DBI-&gt;errstr;
for my $sql (__PACKAGE__-&gt;as_sqls) {
$dbh-&gt;do($sql) or die $dbh-&gt;errstr;
}
$dbh-&gt;disconnect;
}
package main;
use utf8;
use Mojolicious::Lite;
use Mojo::Util qw/md5_sum/;
app-&gt;log-&gt;level('debug')-&gt;path(qq{$0.log});
app-&gt;secret(md5_sum $0 )-&gt;log-&gt;debug(app-&gt;secret);
app-&gt;helper(model =&gt; sub { my $dbh = DataModel-&gt;new });
get '/' =&gt; sub {
my $self  = shift;
my $model = $self-&gt;model;
my $motorbikes =
[$model-&gt;get('motorcycles' =&gt; {order =&gt; [{type =&gt; 'ASC'}],})];
$self-&gt;stash(
motorbikes =&gt; $motorbikes,
debug      =&gt; $self-&gt;dumper([$self, $model]),
);
} =&gt; 'index';
post '/' =&gt; sub {
my $self  = shift;
my $model = $self-&gt;model;
$model-&gt;set(
'motorcycles' =&gt; {
type  =&gt; $self-&gt;param('type'),
brand =&gt; $self-&gt;param('brand'),
color =&gt; $self-&gt;param('color'),
}
);
$self-&gt;redirect_to('/');
};
app-&gt;start;
__DATA__
@@ index.html.ep
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="&lt;%= app-&gt;renderer-&gt;encoding %&gt;"&gt;
&lt;title&gt;Motorcycles&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;table&gt;
% foreach my $cycle (@{$motorbikes} ) {
&lt;tr&gt;
&lt;td&gt;&lt;%= $cycle-&gt;id %&gt;&lt;/td&gt;
&lt;td&gt;&lt;%= $cycle-&gt;type %&gt;&lt;/td&gt;
&lt;td&gt;&lt;%= $cycle-&gt;brand %&gt;&lt;/td&gt;
&lt;td&gt;&lt;%= $cycle-&gt;color %&gt;&lt;/td&gt;
&lt;/tr&gt;
% }
&lt;/table&gt;
&lt;p&gt;バイクを登録してください。&lt;/p&gt;
&lt;p&gt;
&lt;%= form_for '/' =&gt; (method =&gt; 'post') =&gt; begin %&gt;
% foreach (qw/type brand color/) {
&lt;%= uc($_) %&gt;: &lt;%= input_tag $_, 'type' =&gt; 'text' %&gt;&lt;br /&gt;
% }
&lt;%= submit_button 'Submit motorcycle' %&gt;
&lt;% end %&gt;
&lt;/p&gt;
&lt;pre&gt;&lt;%= $debug %&gt;&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;
```
    	