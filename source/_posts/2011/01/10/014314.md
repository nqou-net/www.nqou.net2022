---
categories:
  - 情報技術について
date: 2011-01-10 01:43:14
id: 445
iso8601: 2011-01-10T01:43:14+09:00
tags:
  - jquery
  - mojolicious
  - perl
title: Mojolicious::LiteとData::ModelとjQueryでAJAXなチャットを作ってみた

---

<p>Mojoliciousが1.01になりましたね。
まあ、それとは関係ないですが、jQueryを使ってAJAXなチャットを作ってみたので晒してみようかと思います。
AJAX自体、やった事が無いので、もっと良いやり方があるとは思います。
値の受け渡しはJSONを使ったのですが、Mojolicious側の受け取り方法がよく分からなくて$self->req->jsonとか、Mojo::JSON->newとかやっていたのですが、結果的に普通に$self->paramで受け取れるのがわかって、凄いと思いました。
JavaScript側では、Perlからのtime値をどうやって渡すのかが、調べていてもよく分からなかったので、正解に行き着くのが大変でした。
ミリセカンドで渡す、というのは気づきませんでした。
常識すぎてあまり書かれないんでしょうか&#133;。</p>

<div>
<p>SEE ALSO</p>
<ul>
<li>JavaScript Reference</li>
<li><a href="http://semooh.jp/jquery/">jQuery 日本語リファレンス</a></li>
<li><a href="http://stacktrace.jp/jquery/api/">jQuery API 1.4.4 日本語リファレンス - StackTrace</a></li>
</ul>
</div>



```default
#!/usr/bin/env perl
#ｕｔｆ８
# use Acme::PerlTidy;
use utf8;
package DataModel;
use base 'Data::Model';
use Data::Model::Schema;
use Data::Model::Driver::DBI;
my $dbfile = qq{$0.db};
my $dsn    = qq{dbi:SQLite:dbname=$dbfile};
my $driver = Data::Model::Driver::DBI-&gt;new(
dsn             =&gt; $dsn,
connect_options =&gt; {sqlite_unicode =&gt; 1},
);
base_driver($driver);
install_model messages =&gt; schema {
key 'id';
column id  =&gt; int  =&gt; {auto_increment =&gt; 1};
column msg =&gt; char =&gt; {required       =&gt; 1};
column ts  =&gt; char =&gt; {required       =&gt; 1};
};
unless (-f $dbfile) {
my $dbh = DBI-&gt;connect($dsn, '', '', {RaiseError =&gt; 1, PrintError =&gt; 0})
or DBI-&gt;errstr;
for my $sql (__PACKAGE__-&gt;as_sqls) {
$dbh-&gt;do($sql) or die $dbh-&gt;errstr;
}
$dbh-&gt;disconnect;
}
package main;
use Mojolicious::Lite;
use Mojo::Util qw/md5_sum/;
app-&gt;secret(md5_sum $0 )-&gt;log-&gt;level('debug')-&gt;path(qq{$0.log})
-&gt;debug(app-&gt;secret);
app-&gt;helper(model =&gt; sub { my $dbh = DataModel-&gt;new });
get '/' =&gt; 'index';
get '/json' =&gt; sub {
my $self     = shift;
my $model    = $self-&gt;model;
my $messages = [
$model-&gt;get(
'messages' =&gt; {
where =&gt; [id  =&gt; {'&gt;' =&gt; $self-&gt;param('from_id')}],
order =&gt; [{id =&gt; 'ASC'}],
}
)
];
my @json;
for my $msg (@{$messages}) {
push @json,
{ id  =&gt; $msg-&gt;id,
msg =&gt; $msg-&gt;msg,
ts  =&gt; $msg-&gt;ts,
};
}
$self-&gt;render(json =&gt; [@json]);
} =&gt; 'json';
post '/json' =&gt; sub {
my $self  = shift;
my $time  = time;
my $model = $self-&gt;model;
$model-&gt;set(
'messages' =&gt; {
msg =&gt; $self-&gt;param('msg'),    # jsonもparamで取れる
ts  =&gt; $time,
}
);
};
app-&gt;start;
__DATA__
@@ index.html.ep
% layout 'main';
%= javascript begin
jQuery(function($) {
$("#message").focus();
var params = $.extend({
refresh:5,
timer:0,
latest:0
},params);
var add_log = function(text){
$('#for_ajax').prepend("&lt;p&gt;" + text + "&lt;/p&gt;");
};
var format_date = function(d){
var yyyy = d.getFullYear();
var mm = '0' + (d.getMonth() + 1);
var dd = '0' + d.getDate();
var hh = '0' + d.getHours();
var nn = '0' + d.getMinutes();
var ss = '0' + d.getSeconds();
return yyyy
+ '/' + mm.slice(-2)
+ '/' + dd.slice(-2)
+ ' ' + hh.slice(-2)
+ ':' + nn.slice(-2)
+ ':' + ss.slice(-2);
};
var reload_json = function(){
$.getJSON(
"&lt;%= url_for 'json' %&gt;",
{ 'from_id':params.latest },
function(json) {
$.each(json, function(i, val){
params.latest = val.id;
var latest = new Date();
latest.setTime(val.ts * 1000);
add_log(val.id + ". " + val.msg + " &lt;small&gt;" + format_date(latest) + "&lt;/small&gt;");
});
clearTimeout(params.timer);// 念のためタイマーをリセット
params.timer = setTimeout(reload_json,params.refresh*1000);// 次回の実行はparams.refresh秒後
}
);
};
params.timer = setTimeout(reload_json,0);// 一回目実行
$("#msg_form").submit(function() {
if ( 0 &lt; $("#message").val().length ) {
$.post("&lt;%= url_for 'json' %&gt;", {
'msg':$("#message").val(),
},
function(json) {
}, 'json');
$("#message").val('');
}
return false;
})
});
% end
&lt;div&gt;
&lt;%= form_for '/' =&gt; (method =&gt; 'post', id =&gt; 'msg_form') =&gt; begin %&gt;
&lt;%= text_field 'msg' =&gt; (id =&gt; 'message') %&gt;
&lt;%= submit_button '発言する' %&gt;
&lt;% end %&gt;
&lt;/div&gt;
&lt;div id="for_ajax"&gt;&lt;/div&gt;
@@ layouts/main.html.ep
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="&lt;%= app-&gt;renderer-&gt;encoding %&gt;"&gt;
&lt;title&gt;Mojolicious&lt;/title&gt;
%= javascript 'https://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js'
&lt;/head&gt;
&lt;body&gt;&lt;%= content %&gt;&lt;/body&gt;
&lt;/html&gt;
```
    	