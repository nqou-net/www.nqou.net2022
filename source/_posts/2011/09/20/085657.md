---
categories:
  - 情報技術について
date: 2011-09-20 08:56:57
id: 467
iso8601: 2011-09-20T08:56:57+09:00
tags:
  - perl
title: mixiのコミュニティのトピックから画像をダウンロードするスクリプトを書いた

---

mixiページが始まってから、また、mixiを使うようになりました。
&#133;少しだけですが。
で、コミュニティのトピックを見ていた時に、画像を一つ一つクリックして見るのが面倒になったので、どうにかならないかと思って書きました。
<div id="see_also">
<h2>SEE ALSO</h2>
<ul>
<li><a href="http://search.cpan.org/dist/WWW-Mixi-Scraper/">Kenichi Ishigaki / WWW-Mixi-Scraper - search.cpan.org</a></li>
</ul>
</div>


WWW::Mixi::Scraperを使いました。
WWW::Mixi::Scraper::Plugin::ViewBBSを見てみたところ、トピックのサブジェクトの画像は取得しているのですが、コメントの画像は取得していないので、取得するように改造しました。
```default
--- WWW-Mixi-Scraper-0.33/lib/WWW/Mixi/Scraper/Plugin/ViewBBS.pm	2011-09-20 09:43:10.000000000 +0900
+++ lib/WWW/Mixi/Scraper/Plugin/ViewBBS.pm	2011-09-18 00:07:30.000000000 +0900
@@ -53,7 +53,9 @@
name =&gt; 'TEXT';
process 'dd',
description =&gt; $self-&gt;html_or_text;
-    result qw( link name description );
+    process 'dd&gt;div.communityPhoto&gt;table&gt;tr&gt;td',
+      'images[]' =&gt; $scraper{images};
+    result qw( link name description images );
};
$scraper{list} = scraper {
@@ -77,6 +79,7 @@
# incompatible with WWW::Mixi to let comment links
# look more 'permanent' to make plagger/rss readers happier
+    $comment-&gt;{images} = WWW::Mixi::Scraper::Plugin::_images( $comment-&gt;{images} ) if defined $comment-&gt;{images};
$comment-&gt;{name_link} = _uri( $comment-&gt;{link} );
$comment-&gt;{link}      = $stash-&gt;{link}
? _uri( $stash-&gt;{link} . '#' . $comment-&gt;{subject} )
```
その上で、画像に直接アクセスするように、Pluginを2つほど追加しました。
lib/WWW/Mixi/Plugin/ShowBBSPicture.pm
```default
package WWW::Mixi::Scraper::Plugin::ShowBBSPicture;
use strict;
use warnings;
use WWW::Mixi::Scraper::Plugin;
use WWW::Mixi::Scraper::Utils qw( _uri );
validator {qw(
id        is_number
comm_id   is_number
number    is_number
)};
sub scrape {
my ($self, $html) = @_;
my %scraper;
$scraper{picture} = scraper {
process 'img',
link =&gt; '@src';
result qw( link );
};
# bbs picture
my $stash;
$stash-&gt;{link} = _uri($scraper{picture}-&gt;scrape(\$html));
return $stash;
}
1;
```
lib/WWW/Mixi/Plugin/ShowBBSCommentPicture.pm
```default
package WWW::Mixi::Scraper::Plugin::ShowBBSCommentPicture;
use strict;
use warnings;
use WWW::Mixi::Scraper::Plugin;
use WWW::Mixi::Scraper::Utils qw( _uri );
validator {qw(
bbs_id    is_number
id        is_number
comm_id   is_number
number    is_number
)};
sub scrape {
my ($self, $html) = @_;
my %scraper;
$scraper{picture} = scraper {
process 'img',
link =&gt; '@src';
result qw( link );
};
# bbs picture
my $stash;
$stash-&gt;{link} = _uri($scraper{picture}-&gt;scrape(\$html));
return $stash;
}
1;
```
これらを踏まえた上で、以下が本体です。
./get_mixi_photo.pl http://mixi.jp/view_bbs.pl?id=38584544&comm_id=6896&page=all
という感じに使います。
Config::Pitについては「<a href="http://perl-users.jp/modules/config_pit.html">パスワード設定をコードに書かない(Config::Pit) - モダンなPerl入門 - モダンなPerl入門</a>」を参考にしてアカウント情報を入力してください。
```default
#!/usr/bin/env perl
#ｕｔｆ８
use utf8;
use 5.12.1;
use WWW::Mixi::Scraper;
use lib 'lib';
use Digest::MD5 qw( md5_hex );
use Encode;
use Config::Pit;
my $config = pit_get(
'nqounet@mixi.jp',
require =&gt; {
email =&gt; 'username@domain.com',
password =&gt; 'password',
},
);
use Log::Handler;
my $log = Log::Handler-&gt;new(
file =&gt; {
filename =&gt; 'log/app.log',
utf8 =&gt; 1,
maxlevel =&gt; 'info',# 'debug',
timeformat =&gt; '%Y/%m/%d %H:%M:%S',
message_layout =&gt; '[%T][%L] %m (%C)',
},
);
my $mixi = WWW::Mixi::Scraper-&gt;new(
mode =&gt; 'TEXT',
%{$config},
);
my $topic = shift(@ARGV);
$log-&gt;die('Usage: ./get_mixi_photo.pl topicURL') unless $topic;
my @list = $mixi-&gt;parse( $topic );
$log-&gt;dump( debug =&gt; \@list );
# トピックのタイトル
my $dir = md5_hex( Encode::encode_utf8( $list[0]{subject} ) );
mkdir $dir;
open my $fh, '&gt;:utf8', qq{$dir/info.txt} or $log-&gt;die( qq{Can not open $dir/info.txt.} );
print $fh $list[0]{subject};
close $fh;
# トピックのトップ画像
for my $item ( @{$list[0]{images}} ) {
$log-&gt;dump( debug =&gt; $item-&gt;{link} );
my @urls = $mixi-&gt;parse( $item-&gt;{link} );
for my $url ( @urls ) {
save_url_image( $url, $dir );
}
}
# 各コメントの画像
for my $comment ( @{$list[0]{comments}} ) {
for my $item ( @{$comment-&gt;{images}} ) {
$log-&gt;dump( debug =&gt; $item-&gt;{link} );
my @urls = $mixi-&gt;parse( $item-&gt;{link} );
for my $url ( @urls ) {
save_url_image( $url, $dir );
}
}
}
# 保存一式
sub save_url_image {
my ($url, $dir) = @_;
my $link = $url-&gt;{link}-&gt;as_string;
$log-&gt;dump( debug =&gt; $url-&gt;{link} );
my ($ext) = $link =~ /(\.[a-zA-Z]+)$/ms;
$log-&gt;dump( debug =&gt; $ext );
$ext = '.jpg' unless $ext;
my $filename = md5_hex( $link ) . $ext;
return if -f qq{$dir/$filename};
my $content = $mixi-&gt;{mech}-&gt;get_content( $url-&gt;{link} );
$log-&gt;dump( debug =&gt; $content );
open my $fh, "&gt;:raw", qq{$dir/$filename} or $log-&gt;die( qq{Can not open $dir/$filename.} );
print $fh $content;
close $fh;
}
```
    	