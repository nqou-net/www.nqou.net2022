---
categories:
  - 情報技術について
date: 2010-02-14 21:30:41
id: 415
iso8601: 2010-02-14T21:30:41+09:00
tags:
  - perl
title: NanoAでデータベースを使ってみる

---

小さな事からコツコツと。
ということで、nopasteのデータベース使用版とログイン不要の一行掲示板を作ってみた。
<div>
<p>SEE ALSO</p>
<ul>
<li><a href="http://www.nqou.net">NoPaste(Database) - NanoA@d.n.n</a></li>
<li><a href="http://www.nqou.net">picoBBS - NanoA@d.n.n</a></li>
</ul>
</div>


データベースを使うにあたって、はじめは素のDBIを使っていたのだが、折角なのでプラグインを作ってみた。
&#133;と言っても、MENTAのプラグインをNanoA用に書き直しただけなんだけど。
やはりページネーションが便利ですよ。
```default
package plugin::sql;
use strict;
use warnings;
use utf8;
use base qw(NanoA::Plugin);
sub init_plugin {
my ($klass, $controller) = @_;
no strict 'refs';
no warnings 'redefine';
# Usage: $app-&#62;sql_do($statement);
*{$controller . '::sql_do'} = sub {
my ($app, $sql) = @_;
my $dbh = $app-&#62;db;
$dbh-&#62;do($sql) or die $dbh-&#62;errstr;
};
# Usage: $app-&#62;sql_prepare_exec($statement, \@params);
*{$controller . '::sql_prepare_exec'} = sub {
my ($app, $sql, $params) = @_;
my $dbh = $app-&#62;db;
$params = [] unless ref $params eq 'ARRAY';
my $sth = $dbh-&#62;prepare($sql) or die $dbh-&#62;errstr;
$sth-&#62;execute(@{$params}) or die $dbh-&#62;errstr;
$sth-&#62;finish;
undef $sth;
};
# Usage: my $rows = $app-&#62;sql_select_all($statement, \@params);
# $rows : foreach my $row (@{$rows}) { $row-&#62;{field} }
*{$controller . '::sql_select_all'} = sub {
my ($app, $sql, $params) = @_;
my $dbh = $app-&#62;db;
$params = [] unless ref $params eq 'ARRAY';
my $sth = $dbh-&#62;prepare($sql) or die $dbh-&#62;errstr;
$sth-&#62;execute(@{$params}) or die $dbh-&#62;errstr;
my @res;
while (my $row = $sth-&#62;fetchrow_hashref) {
push @res, $row;
}
$sth-&#62;finish;
undef $sth;
return \@res;
};
# Usage: my ($rows, $pager) = $app-&#62;sql_select_paginate($statement, \@params, { page =&#62; num_of_page, rows =&#62; num_of_rows });
# $rows             : foreach my $row (@{$rows}) { $row-&#62;{field} }
# $pager-&#62;{page}    : page number
# $pager-&#62;{has_next}: has next page
# $pager-&#62;{has_prev}: has prev page
*{$controller . '::sql_select_paginate'} = sub {
my ($app, $sql, $params, $paging) = @_;
my $dbh = $app-&#62;db;
$params = [] unless ref $params eq 'ARRAY';
$sql .= ' LIMIT ? OFFSET ?';
my $sth = $dbh-&#62;prepare($sql) or die $dbh-&#62;errstr;
$sth-&#62;execute(@{$params}, $paging-&#62;{rows}+1, ($paging-&#62;{page}-1)*$paging-&#62;{rows}) or die $dbh-&#62;errstr;
my @res;
while (my $row = $sth-&#62;fetchrow_hashref) {
push @res, $row;
}
$sth-&#62;finish;
undef $sth;
my $has_next = 0;
if ( @res == $paging-&#62;{rows} + 1 ) {
pop @res;
$has_next++;
}
return (\@res, {page =&#62; $paging-&#62;{page}, has_next =&#62; $has_next, has_prev =&#62; ($paging-&#62;{page} != 1) ? 1 : 0});
};
}
# initialize myself
__PACKAGE__-&#62;init_plugin(__PACKAGE__);
1;
```
ついでに、それ用のテンプレートも作ってみた。
まあ、MENTAの（以下略
```default
? my $pager = $c-&gt;{pager};
? my $action = $c-&gt;{action};
? my $page_n = $pager-&gt;{page};
? if ($pager-&gt;{has_prev}) {
&lt;a href="&lt;?= $app-&gt;uri_for($action, { page =&gt; $page_n - 1 }) ?&gt;" rel="prev"&gt;前&lt;/a&gt;
? } else {
&lt;span class="disabled"&gt;前&lt;/span&gt;
? }
|（現在：&lt;?= $page_n ?&gt;ページ）|
? if ($pager-&gt;{has_next}) {
&lt;a href="&lt;?= $app-&gt;uri_for($action, { page =&gt; $page_n + 1 }) ?&gt;" rel="next"&gt;次&lt;/a&gt;
? } else {
&lt;span class="disabled"&gt;次&lt;/span&gt;
? }
```
formプラグインを通じてHTML::AutoFormを使っているが、checkboxのcheckedが思ったように動かない。
checked=>1にしても、チェックが入っていない状態になる。
HTML::AutoFormのtディレクトリにあるコードと同じように書いているのだけど。
何故だ&#133;。
    	